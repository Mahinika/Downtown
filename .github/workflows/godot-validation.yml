name: Godot Validation CI

on:
  push:
    branches: [ master, main ]
    paths:
      - 'downtown/**'
      - 'build_validation.sh'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'downtown/**'
      - 'build_validation.sh'

jobs:
  validate:
    name: Validate Godot Project
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Setup Godot
      uses: josephbmanley/setup-godot@v1
      with:
        version: 4.5.1
        include-templates: true

    - name: Make validation script executable
      run: chmod +x build_validation.sh

    - name: Run validation
      id: validation
      run: |
        ./build_validation.sh
      continue-on-error: true

    - name: Upload validation logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: validation-logs-${{ github.run_number }}
        path: validation_*.log
        retention-days: 30

    - name: Upload Godot logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: godot-logs-${{ github.run_number }}
        path: |
          ~/.local/share/godot/app_userdata/*/logs/
          *.log
        retention-days: 30

    - name: Validation result
      if: steps.validation.outcome == 'success'
      run: echo "✅ Validation passed"

    - name: Validation failed
      if: steps.validation.outcome == 'failure'
      run: |
        echo "❌ Validation failed"
        echo "Check the uploaded log files for details"
        exit 1

  test-export:
    name: Test Export
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        lfs: true

    - name: Setup Godot
      uses: josephbmanley/setup-godot@v1
      with:
        version: 4.5.1
        include-templates: true

    - name: Test HTML5 Export
      run: |
        mkdir -p export_test
        godot --headless --export HTML5 export_test/index.html downtown/project.godot
        if [ -f "export_test/index.html" ]; then
          echo "✅ HTML5 export successful"
        else
          echo "❌ HTML5 export failed"
          exit 1
        fi

    - name: Upload export artifacts
      uses: actions/upload-artifact@v4
      with:
        name: html5-export-${{ github.run_number }}
        path: export_test/
        retention-days: 7